#!/bin/bash
set -e

nextcloud_version="$1"

if [ -z "$nextcloud_version" ]; then
  echo "Nextcloud Version missing"
  exit 1
fi

current_dir="$(pwd)"
generated_combined="$current_dir/docker/cloudfiles/adds/patches/generated/generated_combined.patch"
patches_dir="$current_dir/docker/cloudfiles/build-steps/patches"

combined_patch_is_outdated() {
  if [ ! -f "$generated_combined" ] ; then
    return 0 # not existing
  fi
  for p in "$patches_dir"/* ; do
    if [ "$generated_combined" -ot "$p" ] ; then
      return 0 # outdated
    fi
  done
  return -1 # not outdated
}

if combined_patch_is_outdated ; then
  echo "create-combined-patch: Combined patch $generated_combined is missing or outdated. Rebuilding..."
else
  echo "create-combined-patch: Combined patch $generated_combined exists and seems fresh. Not updating."
  exit 0
fi

temp_dir="$(mktemp -d "${TMPDIR:-/tmp/}$(basename "$0").XXXXXXXXXXXX")"

cd "$temp_dir"
# If ever another minified patch is required I STRONGLY advise reusing the cloned repo and resetting it instead of recloning.
echo "create-combined-patch: Cloning server"
git clone https://github.com/nextcloud/server.git
cd server
git checkout "v$nextcloud_version"

echo "create-combined-patch: Applying patches..."
for f in "$patches_dir"/* ; do
  echo "Applying $f..."
  git apply "$f"
done

echo "create-combined-patch: Downloading JS dependencies..."
make npm-init
echo "create-combined-patch: Build JS artefacts..."
# Note from past self: You cannot use the MODULE env var to speed this build up.
# The resulting file will be loaded in the browser but not executed (No idea why)
make build-js-production

echo "create-combined-patch: Saving diff..."
# We diff everything, not just the generated files, to comply with the open source licence
# Binary because minified sources are excluded from normal diff by nextcloud
echo "This file is autogenerated by build-steps/create-combined-patch" > "$generated_combined"
git diff --binary dist/ >> "$generated_combined"

echo "create-combined-patch: Done"
cd "$current_dir"
rm -rf "$temp_dir"

